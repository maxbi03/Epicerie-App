<!DOCTYPE html>
<html class="light" lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Mon Profil - L'Épicerie du Village</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#13ec49",
                        "forest-green": "#1B4332",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102215",
                    },
                    fontFamily: { display: ["Space Grotesk", "sans-serif"] }
                },
            },
        }
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#111813] antialiased">

<div id="header-container" class="relative z-[100] max-w-md mx-auto"></div>

<main class="relative flex min-h-screen max-w-md mx-auto flex-col overflow-x-hidden">
    <div class="flex-1 overflow-y-auto pb-10">

        <div class="px-5 pt-4 pb-2">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                Profil
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Gérez vos informations personnelles.</p>
        </div>

        <div class="p-5">

            <!-- CARTE PROFIL -->
            <div class="bg-white dark:bg-white/5 rounded-3xl p-6 border border-gray-100 dark:border-white/5 shadow-sm">

                <div class="flex items-center gap-4 mb-4">
                    <div class="size-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center border border-gray-200 dark:border-white/10">
                        <span class="material-symbols-outlined text-forest-green dark:text-white text-3xl">person</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-forest-green dark:text-white" id="user-name">Nom Prénom</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400" id="user-phone-display">Compte actif</p>
                    </div>
                </div>

                <!-- AFFICHAGE -->
                <div id="profile-display">
                    <div class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                        <div class="flex justify-between">
                            <span class="font-semibold">Prénom</span>
                            <span id="user-firstname"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Nom</span>
                            <span id="user-lastname"></span>
                        </div>
                    </div>

                    <button id="edit-profile-btn"
                            class="mt-6 w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg hover:brightness-105 active:scale-95 transition-all">
                        Modifier mes infos
                    </button>
                </div>

                <!-- FORM EDIT -->
                <div id="profile-edit-form" class="hidden">
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm font-semibold text-gray-700 dark:text-gray-300">Prénom</label>
                            <input id="edit-firstname" type="text"
                                   class="w-full mt-1 rounded-xl border-gray-300 focus:ring-primary focus:border-primary"/>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-700 dark:text-gray-300">Nom</label>
                            <input id="edit-lastname" type="text"
                                   class="w-full mt-1 rounded-xl border-gray-300 focus:ring-primary focus:border-primary"/>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-700 dark:text-gray-300">Téléphone</label>
                            <input id="edit-phone" type="text"
                                   class="w-full mt-1 rounded-xl border-gray-300 focus:ring-primary focus:border-primary"/>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-6">
                        <button id="cancel-profile-btn"
                                class="w-full bg-gray-200 text-gray-800 font-bold py-4 rounded-2xl shadow hover:brightness-105 active:scale-95 transition-all">
                            Annuler
                        </button>
                        <button id="save-profile-btn"
                                class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg hover:brightness-105 active:scale-95 transition-all">
                            Enregistrer
                        </button>
                    </div>
                </div>

            </div>

        </div>

    </div>
</main>

<script type="module">
import { supabase } from './supabaseClient.js';

window.addEventListener('DOMContentLoaded', async () => {
    if (typeof initAppShell === 'function') initAppShell();

    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    const { data } = await supabase
        .from('users')
        .select()
        .eq('id', session.user.id)
        .single();

    if (!data) return;

    // Split nom complet en prénom / nom
    const [firstName, ...lastNameParts] = data.name.split(' ');
    const lastName = lastNameParts.join(' ');

    document.getElementById('user-firstname').textContent = firstName || '';
    document.getElementById('user-lastname').textContent = lastName || '';
    document.getElementById('user-phone-display').textContent =
        data.phone || data.email || "Compte actif";
    document.getElementById('user-name').textContent = data.name;

    // FORMULAIRE MODIFICATION
    const editBtn = document.getElementById('edit-profile-btn');
    const profileDisplay = document.getElementById('profile-display');
    const editForm = document.getElementById('profile-edit-form');
    const saveBtn = document.getElementById('save-profile-btn');
    const cancelBtn = document.getElementById('cancel-profile-btn');

    editBtn.addEventListener('click', () => {
        profileDisplay.classList.add('hidden');
        editForm.classList.remove('hidden');

        // Remplir champs avec valeurs actuelles
        document.getElementById('edit-firstname').value = firstName;
        document.getElementById('edit-lastname').value = lastName;
        document.getElementById('edit-phone').value = data.phone || '';
    });

    cancelBtn.addEventListener('click', () => {
        editForm.classList.add('hidden');
        profileDisplay.classList.remove('hidden');
    });

    saveBtn.addEventListener('click', async () => {
        const newFirstName = document.getElementById('edit-firstname').value.trim();
        const newLastName = document.getElementById('edit-lastname').value.trim();
        const newPhone = document.getElementById('edit-phone').value.trim();

        if (!newFirstName || !newLastName) {
            alert("Le prénom et le nom sont obligatoires");
            return;
        }

        const fullName = `${newFirstName} ${newLastName}`;

        const { error } = await supabase
            .from('users')
            .update({ name: fullName, phone: newPhone })
            .eq('id', session.user.id);

        if (error) {
            alert("Erreur lors de la mise à jour : " + error.message);
            return;
        }

        // Mettre à jour l'affichage
        document.getElementById('user-firstname').textContent = newFirstName;
        document.getElementById('user-lastname').textContent = newLastName;
        document.getElementById('user-phone-display').textContent = newPhone || data.email;
        document.getElementById('user-name').textContent = fullName;

        editForm.classList.add('hidden');
        profileDisplay.classList.remove('hidden');
        alert("Informations mises à jour !");
    });
});
</script>

<script src="header.js"></script>

<!-- Auth (logout global + éventuellement affichage nom) -->
<script type="module" src="auth.js"></script>

</body>
</html>